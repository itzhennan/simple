/*
 Template Name: Color Admin - Responsive Admin Dashboard Template build with Twitter Bootstrap 4
 Version: 4.2.0
 Author: Sean Ngu
 Website: http://www.seantheme.com/color-admin-v4.2/admin/
 */
var handleCalendarDemo = function () {
    $("#external-events .fc-event").each(function () {
        $(this).data("event", {
            title: $.trim($(this).text()),
            stick: !0,
            color: $(this).attr("data-color") ? $(this).attr("data-color") : ""
        }), $(this).draggable({zIndex: 999, revert: !0, revertDuration: 0})
    });
    var t = new Date, e = t.getFullYear(), a = t.getMonth() + 1;
    a = a < 10 ? "0" + a : a, $("#calendar").fullCalendar({
        header: {
            left: "month,agendaWeek,agendaDay",
            center: "title",
            right: "prev,today,next "
        },
        // 如果true，日历将永远是6周高。如果false，日历将有4周，5周或6周，具体取决于月份。
        fixedWeekCount: !0,
        // 如果true，日标题和周数将变为可点击。单击时，这些链接将使用户进入表示日/周的视图。
        navLinks:!0,
        monthNames: ['January(1)', 'February(2)', 'March(3)', 'April(4)', 'May(5)', 'June(6)', 'July(7)',
            'August(8)', 'September(9)', 'October(10)', 'November(11)', 'December(12)'],
        // 所有的事件都支持被拖动
        droppable: !0,
        // 对于触摸设备，用户在事件变为可拖动或日期变得可选之前最常按住的时间量。默认 1000
        // longPressDelay: 1000,
        // 对于触摸设备，用户在事件变为可拖动之前最常按住的时间量。1000
        eventLongPressDelay:1000,
        // 对于触摸设备，用户在日期之前按住的时间变得可选。1000
        selectLongPressDelay:100,
        // 从外部拖动后回调
        drop: function (date,jsEvent,ui,resourceId) {
            // $(this).remove(); // 删除外部拖动的元素
        },
        // 拖动停止并且事件已移至不同的日期/时间时触发。
        eventDrop:function(event, delta, revertFunc) {
            dropEvent(event,delta,revertFunc);
        },
        // 从外部拖动后回调  drop之后
        eventReceive:function(calEvent){
            // 外部拖动的元素，只有开始时间，结束时间默认是2个小时
            // alert("外部拖动的元素 调用的方法");
            // alert(calEvent.title);
            // alert(calEvent.start);
            // alert(calEvent.start.hasTime());
            // alert(calEvent.color);
            receiveEvent(calEvent);
        },
        // 调整大小时停止并且事件的持续时间发生变化时触发。
        eventResize: function(event, delta, revertFunc) {
            resizeEvent(event,delta,revertFunc);
        },
        selectable: !0,
        selectHelper: !0,
        select: function (t, e) {
            saveEvent(t,e);
        },
        // 单击触发
        eventClick: function(calEvent, jsEvent, view) {
            updateEvent(calEvent);
        },
        // 所有的事件都支持被修改
        editable: !0,
        eventLimit: !0,
        // 鼠标悬浮触发事件
        // eventRender: function(eventObj, $el) {
        //     $el.popover({
        //         title: eventObj.title,
        //         content: "",
        //         trigger: 'hover',
        //         placement: 'top',
        //         container: 'body'
        //     })
        // },
        // 事件源
        eventSources: [
                {
                    // your event source
                    url: '/calendar/source',
                    type: 'POST',
                    data: {
                        custom_param1: 'something',
                        custom_param2: 'somethingelse'
                    },
                    error: function() {
                        alert('there was an error while fetching events!');
                    }
                }
            ]
        // 所有的事件
        // events: [{title: "All Day Event", start: e + "-" + a + "-01", color: COLOR_GREEN}]
    })
},updateEvent = function(event){ // 点击已存在的 Event 触发
    $IEC.simplePrompt({
        title:"Event Title:",
        placeholder: "Please Input Your Content!",
        content: event.title,
        // 不使用默认按钮，使用自定义按钮
        defaultButtons:false,
        buttons: {
            danger: {text: "Delete", value: {id:event.id}, visible: !0, className: "btn btn-danger", dangerMode: !0},
            cancel: {text: "Cancel", value: null, visible: !0, className: "btn btn-secondary", closeModal: !0},
            confirm: {text: "Submit", value: !0, visible: !0, className: "btn btn-success", closeModal: !0}
        },
        css: function () {
            var leftCss = ".swal-footer .swal-button-container:first-child{float:left;}";
            $IEC.setStyles(leftCss);
        },
        callback: function(name){
            if (!name) throw null;  // 点击 Cancel

            if(typeof name == "object"){ // 点击Delete
                $IEC.simpleConfirm({
                    title: "Are You Sure ?",
                    content: "You Will Delete " +event.title +" ! " ,
                    callback: function(willDelete){
                        if (willDelete) {
                            // Submit!
                            // 点击 Submit
                            $IEC.ajaxCall({
                                uri : $IEC.getCurrentURI() + "/calendar/delete",
                                type : "POST",
                                data : {
                                    "id":event.id
                                },
                                success : function(data) {
                                    if(data.code == 0 ){
                                        $('#calendar').fullCalendar('removeEvents',event.id);
                                        $IEC.simpleAlert({ title:"SUCCESS", icon:"success" });
                                    }else{
                                        $IEC.simpleAlert({ title:"ERROR", icon:"error" });
                                    }
                                },
                                erorr : function() {
                                    $IEC.simpleAlert({ title:"ERROR",icon:"error" });
                                }
                            });
                        } else {
                            // Close!
                        }
                    },
                });

            }else{
                // 点击 Submit
                $IEC.ajaxCall({
                    uri : $IEC.getCurrentURI() + "/calendar/editTitle",
                    type : "POST",
                    data : {
                        "title":name,
                        "id":event.id
                    },
                    success : function(data) {
                        if(data.code == 0 ){
                            event.title = name;
                            $('#calendar').fullCalendar('updateEvent', event);
                            $IEC.simpleAlert({ title:"SUCCESS", icon:"success" });
                        }else{
                            $IEC.simpleAlert({ title:"ERROR", icon:"error" });
                        }
                    },
                    erorr : function() {
                        $IEC.simpleAlert({ title:"ERROR",icon:"error" });
                    }
                });
            }
        }
    });
},saveEvent = function(t,e){ // 点击空的Event 触发
    $IEC.simplePrompt({
        title:"Event Title:",
        placeholder: "Please Input Your Content!",
        content: event.title,
        callback: function(name){
            if(!name){
                return;
            }
            $IEC.ajaxCall({
                uri : $IEC.getCurrentURI() + "/calendar/save",
                type : "POST",
                data : {
                    "title":name,
                    "start": t,
                    "end": e,
                    "type":t.hasTime()?0:1
                },
                success : function(data) {
                    if(data.code == 0 ){
                        var a,id = data.msg;
                        name && (a = {
                            title: name,
                            start: t,
                            end: e,
                            id: id
                        }, $("#calendar").fullCalendar("renderEvent", a, !0)), $("#calendar").fullCalendar("unselect");
                        $IEC.simpleAlert({ title:"SUCCESS", icon:"success" });
                    }else{
                        $IEC.simpleAlert({ title:"ERROR", icon:"error" });
                    }
                },
                erorr : function() {
                    $IEC.simpleAlert({ title:"ERROR",icon:"error" });
                }
            });
        }
    });
},receiveEvent = function(calEvent){ // 从外部拖入新的Event 触发

    $IEC.simplePrompt({
        title:"Event Title:",
        placeholder: "Please Input Your Content!",
        content: calEvent.title,
        callback: function(name){
            if(!name){
                // 用户点击了关闭   把当前Event给删除
                $('#calendar').fullCalendar('removeEvents',function(event){
                    if(!event.id){ // 删除ID为空的
                        return true;
                    }else{
                        return false;
                    }
                });
                return;
            }
            $IEC.ajaxCall({
                uri : $IEC.getCurrentURI() + "/calendar/save",
                type : "POST",
                data : {
                    "title":name,
                    "start": calEvent.start,
                    "type": calEvent.start.hasTime()?0:1,
                    "color": calEvent.color
                },
                success : function(data) {
                    if(data.code == 0 ){
                        calEvent.title = name;
                        calEvent.id = data.msg;
                        $('#calendar').fullCalendar('updateEvent', calEvent);
                        $IEC.simpleAlert({ title:"SUCCESS", icon:"success" });
                    }else{
                        $IEC.simpleAlert({ title:"ERROR", icon:"error" });
                        $('#calendar').fullCalendar('refetchEvents');
                    }
                },
                erorr : function() {
                    $IEC.simpleAlert({ title:"ERROR",icon:"error" });
                    $('#calendar').fullCalendar('refetchEvents');
                }
            });
        }
    });
},dropEvent = function(event,delta,revertFunc){ // 对已经存在的Event 拖动并更改了时间，但并未更改时间长度
    $IEC.simpleConfirm({
        title: "Are you sure about this change?",
        content: event.title + " was dropped on " + event.start.format(),
        callback: function(willDelete){
            if (willDelete) {
                // Submit!
                $IEC.ajaxCall({
                    uri : $IEC.getCurrentURI() + "/calendar/editAllTime",
                    type : "POST",
                    data : {
                        "start": event.start.format(),
                        "time" : delta+"",
                        "id"   : event.id,
                        "type" : event.start.hasTime()?0:1
                    },
                    success : function(data) {
                        if(data.code == 0 ){
                            $IEC.simpleAlert({ title:"SUCCESS", icon:"success" });
                        }else{
                            $IEC.simpleAlert({ title:"ERROR", icon:"error" });
                            revertFunc();
                        }
                    },
                    erorr : function() {
                        $IEC.simpleAlert({ title:"ERROR",icon:"error" });
                        revertFunc();
                    }
                });
            } else {
                // Close!
                revertFunc();
            }
        }
    });
},resizeEvent = function(event,delta,revertFunc){ // 对已经存在的Event 更改了时间长度，但并未更改开始时间
    $IEC.simpleConfirm({
        title: "Is this okay?",
        content: event.title + " end is now " + event.end.format(),
        callback: function(willDelete){
            if (willDelete) {
                // Submit!
                $IEC.ajaxCall({
                    uri : $IEC.getCurrentURI() + "/calendar/editEndTime",
                    type : "POST",
                    data : {
                        "end": event.end.format(),
                        "time" : delta+"",
                        "id"   : event.id,
                        "type" : 0
                    },
                    success : function(data) {
                        if(data.code == 0 ){
                            $IEC.simpleAlert({ title:"SUCCESS", icon:"success" });
                        }else{
                            $IEC.simpleAlert({ title:"ERROR", icon:"error" });
                            revertFunc();
                        }
                    },
                    erorr : function() {
                        $IEC.simpleAlert({ title:"ERROR",icon:"error" });
                        revertFunc();
                    }
                });
            } else {
                // Close!
                revertFunc();
            }
        }
    });
}, Calendar = function () {
    "use strict";
    return {
        init: function () {
            handleCalendarDemo()
        }
    }
}();